<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.troytan.ymcake.repository.OrderMapper">
  <resultMap id="BaseResultMap" type="com.troytan.ymcake.domain.Order">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    <id column="ORDER_ID" jdbcType="INTEGER" property="orderId" />
    <result column="status" jdbcType="SMALLINT" property="status" />
    <result column="price" jdbcType="DECIMAL" property="price" />
    <result column="created_on" jdbcType="TIMESTAMP" property="createdOn" />
    <result column="created_by" jdbcType="VARCHAR" property="createdBy" />
    <result column="updated_on" jdbcType="TIMESTAMP" property="updatedOn" />
    <result column="updated_by" jdbcType="VARCHAR" property="updatedBy" />
    <result column="transaction_id" jdbcType="VARCHAR" property="transactionId" />
    <result column="USER_ID" jdbcType="INTEGER" property="userId" />
    <result column="DELIVERY_ID" jdbcType="INTEGER" property="deliveryId" />
    <result column="remark" jdbcType="VARCHAR" property="remark" />
    <result column="delivery_fee" jdbcType="DECIMAL" property="deliveryFee" />
    <result column="pay_method" jdbcType="SMALLINT" property="payMethod" />
  </resultMap>
  <delete id="deleteByPrimaryKey" parameterType="Long">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    delete from tt_order
    where ORDER_ID = #{orderId,jdbcType=INTEGER}
  </delete>
  <insert id="insert" parameterType="com.troytan.ymcake.domain.Order">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    <selectKey keyProperty="orderId" order="AFTER" resultType="Long">
      SELECT LAST_INSERT_ID()
    </selectKey>
    insert into tt_order (status, price, created_on, 
      created_by, updated_on, updated_by, 
      transaction_id, USER_ID, DELIVERY_ID, 
      remark, delivery_fee, pay_method
      )
    values (#{status,jdbcType=SMALLINT}, #{price,jdbcType=DECIMAL}, now(), 
      #{createdBy,jdbcType=VARCHAR}, #{updatedOn,jdbcType=TIMESTAMP}, #{updatedBy,jdbcType=VARCHAR}, 
      #{transactionId,jdbcType=VARCHAR}, #{userId,jdbcType=INTEGER}, #{deliveryId,jdbcType=INTEGER}, 
      #{remark,jdbcType=VARCHAR}, #{deliveryFee,jdbcType=DECIMAL}, #{payMethod,jdbcType=SMALLINT}
      )
  </insert>
  <update id="updateByPrimaryKey" parameterType="com.troytan.ymcake.domain.Order">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    update tt_order
    set status = #{status,jdbcType=SMALLINT},
      price = #{price,jdbcType=DECIMAL},
      updated_on = #{updatedOn,jdbcType=TIMESTAMP},
      updated_by = #{updatedBy,jdbcType=VARCHAR},
      transaction_id = #{transactionId,jdbcType=VARCHAR},
      USER_ID = #{userId,jdbcType=INTEGER},
      DELIVERY_ID = #{deliveryId,jdbcType=INTEGER},
      remark = #{remark,jdbcType=VARCHAR},
      delivery_fee = #{deliveryFee,jdbcType=DECIMAL},
      pay_method = #{payMethod,jdbcType=SMALLINT}
    where ORDER_ID = #{orderId,jdbcType=INTEGER}
  </update>
  <select id="selectByPrimaryKey" parameterType="Long" resultMap="BaseResultMap">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    select ORDER_ID, status, price, created_on, created_by, updated_on, updated_by, transaction_id, 
    USER_ID, DELIVERY_ID, remark, delivery_fee, pay_method
    from tt_order
    where ORDER_ID = #{orderId,jdbcType=INTEGER}
  </select>
  <select id="selectAll" resultMap="BaseResultMap">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    select ORDER_ID, status, price, created_on, created_by, updated_on, updated_by, transaction_id, 
    USER_ID, DELIVERY_ID, remark, delivery_fee, pay_method
    from tt_order
  </select>
  
  <!-- 更新订单状态 -->
  <update id="updateStatusById">
    update tt_order set STATUS=#{status, jdbcType=SMALLINT}
    where ORDER_ID =#{orderId, jdbcType=DECIMAL}
  </update>
  <resultMap id="OrderVoResultMap" type="com.troytan.ymcake.vo.OrderVo">
    <id column="ORDER_ID" jdbcType="INTEGER" property="orderId" />
    <result column="status" jdbcType="SMALLINT" property="status" />
    <result column="created_on" jdbcType="TIMESTAMP" property="createdOn" />
    <result column="pay_method" jdbcType="SMALLINT" property="payMethod" />
    <result column="deliver_method" jdbcType="SMALLINT" property="deliverMethod" />
    <result column="delivery_no" jdbcType="VARCHAR" property="deliveryNo" />
    <result column="location" jdbcType="VARCHAR" property="location" />
    <result column="receiver" jdbcType="VARCHAR" property="receiver" />
    <result column="remark" jdbcType="VARCHAR" property="remark" />
    <result column="price" jdbcType="DECIMAL" property="price" />
    <result column="delivery_fee" jdbcType="DECIMAL" property="deliveryFee" />
    <collection ofType="com.troytan.ymcake.vo.OrderProductVo" property="productList">
        <result column="PRODUCT_ID" jdbcType="DECIMAL" property="productId" />
        <result column="count" jdbcType="SMALLINT" property="count" />
        <result column="description" jdbcType="VARCHAR" property="sizeDescription" />
        <result column="product_price" jdbcType="DECIMAL" property="price" />
        <result column="name" jdbcType="VARCHAR" property="name" />
        <result column="img_url" jdbcType="VARCHAR" property="imgUrl" />
        <result column="product_str" jdbcType="VARCHAR" property="productStr" />
    </collection>
  </resultMap>
  <select id="listByStatus" resultMap="OrderVoResultMap">
	select o.order_id, o.created_on, o.pay_method, o.status,o.price,o.remark,o.delivery_fee,
	    d.deliver_method, d.delivery_no,concat(a.area_str,a.detail) as location,
	    concat_ws(' ',a.receiver,a.phone) as receiver,
	    po.PRODUCT_ID,po.count,
	    s.description,s.price as product_price,
	    p.name, p.img_url,
	    concat_ws(' ',p.name,left(s.description,4),'x',po.count) as product_str
	from tt_order o
	left join tt_delivery d on d.DELIVERY_ID=o.DELIVERY_ID
	left join tt_addr a on a.addr_id = d.ADDR_ID
	left join tr_product_order po on po.ORDER_ID = o.ORDER_ID
	left join tt_product p on p.PRODUCT_ID=po.PRODUCT_ID
	left join tt_size s on s.size_id = po.size_id
	where 
	    <if test="status != -1">
	       o.status=#{status, jdbcType=SMALLINT} and
	    </if> 
	    <if test="userId !=null">
	       o.USER_ID =#{userId, jdbcType=DECIMAL} and
	    </if>
	    o.status != 200
	order by created_on desc
  </select>
  <select id="countOrderGroupByStatus" resultType="com.troytan.ymcake.dto.OrderCountDto">
	select count(status) as count,status from tt_order
	where status in (1,10,50,90) and 
	  USER_ID =#{userId, jdbcType=DECIMAL} and
	  status != 200
	group by status
  </select>
  
</mapper>